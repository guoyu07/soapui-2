{
  try {
    getProperty("Request").setValue(request.getRequestContent());
    long delay=getResponseDelay();
    if (delay > 0)     Thread.sleep(delay);
    String script=getScript();
    if (script != null && script.trim().length() > 0) {
      evaluateScript(request);
    }
    String responseContent=getResponseContent();
    WsdlMockRunContext context=new WsdlMockRunContext(request.getContext().getMockService(),null);
    context.setMockResponse(this);
    context.putAll(request.getContext());
    context.putAll(request.getRequestContext());
    StringToStringsMap responseHeaders=getResponseHeaders();
    for (    Map.Entry<String,List<String>> headerEntry : responseHeaders.entrySet()) {
      for (      String value : headerEntry.getValue())       result.addHeader(headerEntry.getKey(),PropertyExpander.expandProperties(context,value));
    }
    responseContent=PropertyExpander.expandProperties(context,responseContent,isEntitizeProperties());
    if (this.getWsaConfig().isWsaEnabled()) {
      responseContent=new WsaUtils(responseContent,getSoapVersion(),getMockOperation().getOperation(),context).addWSAddressingMockResponse(this,request);
    }
    String outgoingWss=getOutgoingWss();
    if (StringUtils.isNullOrEmpty(outgoingWss))     outgoingWss=getMockOperation().getMockService().getOutgoingWss();
    if (StringUtils.hasContent(outgoingWss)) {
      OutgoingWss outgoing=((WsdlProject)getMockOperation().getMockService().getProject()).getWssContainer().getOutgoingWssByName(outgoingWss);
      if (outgoing != null) {
        Document dom=XmlUtils.parseXml(responseContent);
        outgoing.processOutgoing(dom,context);
        StringWriter writer=new StringWriter();
        XmlUtils.serialize(dom,writer);
        responseContent=writer.toString();
      }
    }
    if (!result.isCommitted()) {
      responseContent=writeResponse(result,responseContent);
    }
    result.setResponseContent(responseContent);
    setMockResult(result);
    return result;
  }
 catch (  Throwable e) {
    SoapUI.logError(e);
    throw new DispatchException(e);
  }
}
