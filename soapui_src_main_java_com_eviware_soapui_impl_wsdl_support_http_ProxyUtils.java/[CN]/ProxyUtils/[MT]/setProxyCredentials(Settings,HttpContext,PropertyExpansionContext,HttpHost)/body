{
  String proxyUsername=getExpandedProperty(context,settings,ProxySettings.USERNAME);
  String proxyPassword=getExpandedProperty(context,settings,ProxySettings.PASSWORD);
  if (!StringUtils.isNullOrEmpty(proxyUsername) && !StringUtils.isNullOrEmpty(proxyPassword)) {
    Credentials proxyCreds=new UsernamePasswordCredentials(proxyUsername,proxyPassword);
    int ix=proxyUsername.indexOf('\\');
    String hostName=proxy == null ? null : proxy.getHostName();
    int port=proxy == null ? -1 : proxy.getPort();
    if (ix > 0) {
      String domain=proxyUsername.substring(0,ix);
      if (proxyUsername.length() > ix + 1) {
        String user=proxyUsername.substring(ix + 1);
        proxyCreds=new NTCredentials(user,proxyPassword,hostName,domain);
      }
    }
    CredentialsProvider credsProvider=new BasicCredentialsProvider();
    credsProvider.setCredentials(new AuthScope(hostName,port),proxyCreds);
    httpContext.setAttribute(ClientContext.CREDS_PROVIDER,credsProvider);
  }
}
