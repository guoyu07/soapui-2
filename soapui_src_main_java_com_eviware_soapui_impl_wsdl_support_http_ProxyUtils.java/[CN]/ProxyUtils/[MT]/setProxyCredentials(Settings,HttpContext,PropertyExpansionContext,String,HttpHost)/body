{
  String proxyUsername=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.USERNAME,null));
  String proxyPassword=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.PASSWORD,null));
  if (proxyUsername != null && proxyPassword != null && (proxyUsername.trim().length() > 0 && proxyPassword.trim().length() > 0)) {
    Credentials proxyCreds=new UsernamePasswordCredentials(proxyUsername,proxyPassword);
    int ix=proxyUsername.indexOf('\\');
    if (ix > 0) {
      String domain=proxyUsername.substring(0,ix);
      if (proxyUsername.length() > ix + 1) {
        String user=proxyUsername.substring(ix + 1);
        proxyCreds=new NTCredentials(user,proxyPassword,proxyHost,domain);
      }
    }
    CredentialsProvider credsProvider=new BasicCredentialsProvider();
    credsProvider.setCredentials(new AuthScope(proxy.getHostName(),proxy.getPort()),proxyCreds);
    httpContext.setAttribute(ClientContext.CREDS_PROVIDER,credsProvider);
  }
}
