{
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  ExtendedPostMethod postMethod=new ExtendedPostMethod();
  if (capturedData == null) {
    capturedData=new JProxyServletWsdlMonitorMessageExchange(project);
    capturedData.setRequestHost(httpRequest.getServerName());
    capturedData.setRequestHeader(httpRequest);
    capturedData.setTargetURL(httpRequest.getRequestURL().toString());
  }
  CaptureInputStream capture=new CaptureInputStream(httpRequest.getInputStream());
  String connectionHeader=httpRequest.getHeader("Connection");
  if (connectionHeader != null) {
    connectionHeader=connectionHeader.toLowerCase();
    if (connectionHeader.indexOf("keep-alive") < 0 && connectionHeader.indexOf("close") < 0)     connectionHeader=null;
  }
  boolean xForwardedFor=false;
  @SuppressWarnings("unused") long contentLength=-1;
  Enumeration<?> headerNames=httpRequest.getHeaderNames();
  while (headerNames.hasMoreElements()) {
    String hdr=(String)headerNames.nextElement();
    String lhdr=hdr.toLowerCase();
    if (dontProxyHeaders.contains(lhdr))     continue;
    if (connectionHeader != null && connectionHeader.indexOf(lhdr) >= 0)     continue;
    if ("content-length".equals(lhdr))     contentLength=request.getContentLength();
    Enumeration<?> vals=httpRequest.getHeaders(hdr);
    while (vals.hasMoreElements()) {
      String val=(String)vals.nextElement();
      if (val != null) {
        postMethod.setRequestHeader(lhdr,val);
        xForwardedFor|="X-Forwarded-For".equalsIgnoreCase(hdr);
      }
    }
  }
  postMethod.setRequestHeader("Via","SoapUI Monitor");
  if (!xForwardedFor)   postMethod.addRequestHeader("X-Forwarded-For",request.getRemoteAddr());
  postMethod.setRequestEntity(new InputStreamRequestEntity(capture,"text/xml; charset=utf-8"));
  HostConfiguration hostConfiguration=new HostConfiguration();
  String url="http://" + httpRequest.getServerName() + ":"+ httpRequest.getServerPort()+ httpRequest.getServletPath();
  hostConfiguration.setHost(new URI(url,true));
  postMethod.setPath(url);
  SoapUI.log("PROXY to:" + url);
  if (settings.getBoolean(LaunchForm.SSLTUNNEL_REUSESTATE)) {
    if (httpState == null)     httpState=new HttpState();
    client.executeMethod(hostConfiguration,postMethod,httpState);
  }
 else {
    client.executeMethod(hostConfiguration,postMethod);
  }
  capturedData.stopCapture();
  byte[] res=postMethod.getResponseBody();
  IO.copy(new ByteArrayInputStream(postMethod.getResponseBody()),response.getOutputStream());
  capturedData.setRequest(capture.getCapturedData());
  capturedData.setResponse(res);
  capturedData.setResponseHeader(postMethod);
  capturedData.setRawRequestData(getRequestToBytes(postMethod,capture));
  capturedData.setRawResponseData(getResponseToBytes(postMethod,res));
  monitor.addMessageExchange(capturedData);
  capturedData=null;
  postMethod.releaseConnection();
}
