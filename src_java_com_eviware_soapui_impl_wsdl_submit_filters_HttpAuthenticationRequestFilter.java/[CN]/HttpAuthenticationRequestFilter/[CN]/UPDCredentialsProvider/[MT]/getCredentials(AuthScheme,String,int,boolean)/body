{
  if (checkedCredentials)   throw new CredentialsNotAvailableException("Missing valid credentials");
  if (authscheme == null) {
    return null;
  }
  try {
    if (authscheme instanceof NTLMScheme) {
      logger.info(host + ":" + port+ " requires Windows authentication");
      return new NTCredentials(username,password,host,domain);
    }
 else     if (authscheme instanceof RFC2617Scheme) {
      logger.info(host + ":" + port+ " requires authentication with the realm '"+ authscheme.getRealm()+ "'");
      return new UsernamePasswordCredentials(username,password);
    }
 else {
      throw new CredentialsNotAvailableException("Unsupported authentication scheme: " + authscheme.getSchemeName());
    }
  }
 catch (  IOException e) {
    throw new CredentialsNotAvailableException(e.getMessage(),e);
  }
 finally {
    checkedCredentials=true;
  }
}
