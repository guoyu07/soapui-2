{
  HttpHost proxy=null;
  boolean enabled=proxyEnabled;
  String proxyHost=System.getProperty("http.proxyHost");
  String proxyPort=System.getProperty("http.proxyPort");
  if (proxyHost == null)   proxyHost=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.HOST,""));
  if (proxyPort == null && proxyHost != null)   proxyPort=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.PORT,""));
  if (!StringUtils.isNullOrEmpty(proxyHost) && !StringUtils.isNullOrEmpty(proxyPort)) {
    String[] excludes=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.EXCLUDES,"")).split(",");
    try {
      URL url=new URL(urlString);
      if (!excludes(excludes,url.getHost(),url.getPort())) {
        proxy=new HttpHost(proxyHost,Integer.parseInt(proxyPort));
        String proxyUsername=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.USERNAME,null));
        String proxyPassword=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.PASSWORD,null));
        if (proxyUsername != null && proxyPassword != null) {
          Credentials proxyCreds=new UsernamePasswordCredentials(proxyUsername,proxyPassword == null ? "" : proxyPassword);
          int ix=proxyUsername.indexOf('\\');
          if (ix > 0) {
            String domain=proxyUsername.substring(0,ix);
            if (proxyUsername.length() > ix + 1) {
              String user=proxyUsername.substring(ix + 1);
              proxyCreds=new NTCredentials(user,proxyPassword,proxyHost,domain);
            }
          }
          if (enabled) {
            HttpClientSupport.getHttpClient().getCredentialsProvider().setCredentials(new AuthScope(proxy.getHostName(),proxy.getPort()),proxyCreds);
            HttpClientSupport.getHttpClient().getParams().setParameter(ConnRoutePNames.DEFAULT_PROXY,proxy);
          }
 else {
            HttpClientSupport.getHttpClient().getCredentialsProvider().setCredentials(new AuthScope(proxy.getHostName(),proxy.getPort()),null);
            HttpClientSupport.getHttpClient().getParams().removeParameter(ConnRoutePNames.DEFAULT_PROXY);
          }
        }
      }
    }
 catch (    MalformedURLException e) {
      SoapUI.logError(e);
    }
  }
}
