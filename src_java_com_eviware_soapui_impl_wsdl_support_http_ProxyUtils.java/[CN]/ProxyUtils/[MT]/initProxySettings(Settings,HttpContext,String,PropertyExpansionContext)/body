{
  HttpHost proxy=null;
  boolean enabled=proxyEnabled;
  String proxyHost=System.getProperty("http.proxyHost");
  String proxyPort=System.getProperty("http.proxyPort");
  if (proxyHost == null && enabled)   proxyHost=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.HOST,""));
  if (proxyPort == null && proxyHost != null && enabled)   proxyPort=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.PORT,""));
  if (!StringUtils.isNullOrEmpty(proxyHost) && !StringUtils.isNullOrEmpty(proxyPort)) {
    String[] excludes=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.EXCLUDES,"")).split(",");
    try {
      URL url=new URL(urlString);
      if (!excludes(excludes,url.getHost(),url.getPort())) {
        proxy=new HttpHost(proxyHost,Integer.parseInt(proxyPort));
        String proxyUsername=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.USERNAME,null));
        String proxyPassword=PropertyExpander.expandProperties(context,settings.getString(ProxySettings.PASSWORD,null));
        if (proxyUsername != null && proxyPassword != null) {
          Credentials proxyCreds=new UsernamePasswordCredentials(proxyUsername,proxyPassword == null ? "" : proxyPassword);
          int ix=proxyUsername.indexOf('\\');
          if (ix > 0) {
            String domain=proxyUsername.substring(0,ix);
            if (proxyUsername.length() > ix + 1) {
              String user=proxyUsername.substring(ix + 1);
              proxyCreds=new NTCredentials(user,proxyPassword,proxyHost,domain);
            }
          }
          httpContext.setAttribute(ExecutionContext.HTTP_PROXY_HOST,proxy);
          AuthState authState=new AuthState();
          authState.setAuthScope(new AuthScope(AuthScope.ANY_HOST,AuthScope.ANY_PORT));
          authState.setCredentials(proxyCreds);
          httpContext.setAttribute(ClientContext.PROXY_AUTH_STATE,authState);
        }
      }
    }
 catch (    MalformedURLException e) {
      SoapUI.logError(e);
    }
  }
}
