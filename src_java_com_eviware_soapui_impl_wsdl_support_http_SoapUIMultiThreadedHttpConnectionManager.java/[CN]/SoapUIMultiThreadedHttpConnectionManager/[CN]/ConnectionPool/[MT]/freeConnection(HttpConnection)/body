{
  HostConfiguration connectionConfiguration=configurationForConnection(conn);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Freeing connection, hostConfig=" + connectionConfiguration);
  }
synchronized (this) {
    if (shutdown) {
      conn.close();
      return;
    }
    HostConnectionPool hostPool=getHostPool(connectionConfiguration,true);
    hostPool.freeConnections.add(conn);
    if (hostPool.numConnections == 0) {
      LOG.error("Host connection pool not found, hostConfig=" + connectionConfiguration);
      hostPool.numConnections=1;
    }
    freeConnections.add(conn);
    removeReferenceToConnection((HttpConnectionWithReference)conn);
    if (numConnections == 0) {
      LOG.error("Host connection pool not found, hostConfig=" + connectionConfiguration);
      numConnections=1;
    }
    idleConnectionHandler.add(conn);
    notifyWaitingThread(hostPool);
  }
}
