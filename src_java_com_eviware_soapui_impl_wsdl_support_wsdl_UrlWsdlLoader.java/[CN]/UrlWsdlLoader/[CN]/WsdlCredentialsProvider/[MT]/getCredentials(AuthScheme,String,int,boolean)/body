{
  if (authscheme == null) {
    return null;
  }
  try {
    String pw=getPassword();
    if (pw == null)     pw="";
    if (authscheme instanceof NTLMScheme) {
      if (hasCredentials()) {
        log.info("Returning url credentials");
        return new NTCredentials(getUsername(),pw,host,null);
      }
      log.info(host + ":" + port+ " requires Windows authentication");
      if (ntDialog == null) {
        buildNtDialog();
      }
      StringToStringMap values=new StringToStringMap();
      values.put("Info","Authentication required for [" + host + ":"+ port+ "]");
      ntDialog.setValues(values);
      if (ntDialog.show()) {
        values=ntDialog.getValues();
        return new NTCredentials(values.get("Username"),values.get("Password"),host,values.get("Domain"));
      }
 else       throw new CredentialsNotAvailableException("Operation cancelled");
    }
 else     if (authscheme instanceof RFC2617Scheme) {
      if (hasCredentials()) {
        log.info("Returning url credentials");
        return new UsernamePasswordCredentials(getUsername(),pw);
      }
      log.info(host + ":" + port+ " requires authentication with the realm '"+ authscheme.getRealm()+ "'");
      if (basicDialog == null)       buildBasicDialog();
      StringToStringMap values=new StringToStringMap();
      values.put("Info","Authentication required for [" + host + ":"+ port+ "]");
      basicDialog.setValues(values);
      if (basicDialog.show()) {
        values=basicDialog.getValues();
        return new UsernamePasswordCredentials(values.get("Username"),values.get("Password"));
      }
 else       throw new CredentialsNotAvailableException("Operation cancelled");
    }
 else {
      throw new CredentialsNotAvailableException("Unsupported authentication scheme: " + authscheme.getSchemeName());
    }
  }
 catch (  IOException e) {
    throw new CredentialsNotAvailableException(e.getMessage(),e);
  }
}
